name: Deploy to Azure App Service

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 手動実行を許可

jobs:
  # 変更されたファイルを検出するジョブ
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'

  # Frontend デプロイジョブ
  deploy-frontend:
    needs: detect-changes
    # 強制実行（初回デプロイのため）
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package.json
      
      - name: Clean and install dependencies
        run: |
          cd frontend
          rm -rf .next out node_modules/.cache
          npm ci --legacy-peer-deps
      
      - name: Build frontend
        env:
          NEXT_PUBLIC_API_BASE_URL: https://tech0-gen-11-step3-2-py-26.azurewebsites.net
          NODE_ENV: production
        run: |
          cd frontend
          npm run build
          
      - name: Verify build output
        run: |
          cd frontend
          echo "Checking build output directory..."
          ls -la out/ || echo "out directory not found"
          if [ -d "out" ]; then
            echo "Build output contents:"
            find out -type f -name "*.js" -o -name "*.css" -o -name "*.html" | head -20
          else
            echo "ERROR: Build output directory 'out' not found!"
            exit 1
          fi
      
      - name: Deploy to Azure App Service (Frontend)
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'tech0-gen-11-step3-2-node-26'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_FRONTEND }}
          package: './frontend/out'
          clean: true
          restart: true

  # Backend デプロイジョブ（一時的に無効化 - Backendは動作中）
  deploy-backend:
    needs: detect-changes
    if: false  # 一時的に無効化
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies and create requirements
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # 依存関係を確認
          pip list > installed_packages.txt
          echo "Installed packages:"
          cat installed_packages.txt
      
      # テストを一時的にスキップ（初回デプロイのため）
      # - name: Run backend tests
      #   run: |
      #     cd backend
      #     python -m pytest tests/ -v
      #   continue-on-error: false
      
      # リンティングを一時的にスキップ（初回デプロイのため）
      # - name: Run backend linting
      #   run: |
      #     cd backend
      #     python -m flake8 . --exclude=alembic
      #   continue-on-error: false
      
      - name: Deploy to Azure App Service (Backend)
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'tech0-gen-11-step3-2-py-26'  # ここを実際のApp Service名に変更
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND }}
          package: './backend'